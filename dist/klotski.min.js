/*
 * klotski 2.0.0
 * The JavaScript algorithm for solving klotski game.
 * 
 *
 * Copyright 2017, jeantimex <jean.timex@gmail.com>
 * Released under the MIT license.
*/

!function(){"use strict";var p=!0,v=5,x=4,I=x+2,w=v+2,m=3,g=1;function r(){var b,y=[{x:0,y:1},{x:1,y:0},{x:0,y:-1},{x:-1,y:0}];function k(r,o){return r[o[0]+"-"+o[1]]}function f(r,o,e,t){for(var n=t?r.hashMirror:r.hash,a=r.blocks[o],s=a.shape,l=a.row,i=k(r.types,s),f=t?x-1-a.col:a.col,u=t?-1:1,c=y[t&&e%2==1?(e+2)%4:e],h=c.x,d=c.y,p=0;p<s[0];p++)for(var v=0;v<s[1];v++)n^=b.key[l+p][f+v*u].value[i],n^=b.key[l+p][f+v*u].value[0];for(p=0;p<s[0];p++)for(v=0;v<s[1];v++)n^=b.key[l+d+p][f+h+v*u].value[0],n^=b.key[l+d+p][f+h+v*u].value[i];return n}function n(r,o){var e;for(e=0;e<r;e++)o.value[e]=t()}function t(){for(var r=0;!(r=Math.floor(Math.random()*Math.pow(2,31))););return parseInt(r)}function u(r,o,e,t,n){for(var a=1;a<=e[0];a++)for(var s=1;s<=e[1];s++)r.board[t+a][n+s]=o+1}function a(r,o,e){return!!function(r,o,e,t){for(var n=1;n<=o[0];n++)for(var a=1;a<=o[1];a++)if(0!==r.board[e+n][t+a])return!1;return!0}(r,e.shape,e.row,e.col)&&(u(r,o,e.shape,e.row,e.col),function(r,o){var e=o[0]+"-"+o[1];r[e]||(r[e]=Object.keys(r).length+1)}(r.types,e.shape),r.blocks.push(e),!0)}function e(r){var o={states:[],zhash:{},result:{time:null,moves:[]}},e={board:[],blocks:[],types:{},move:{blockIdx:0,dirIdx:0},step:0,hash:0,hashMirror:0,parent:null};if(function(r){var o,e;for(o=0;o<w;o++)for(r.board[o]=[],e=0;e<I;e++)r.board[o][e]=0;for(o=0;o<I;o++)r.board[0][o]=-1,r.board[w-1][o]=-1;for(o=1;o<w-1;o++)r.board[o][0]=-1,r.board[o][I-1]=-1}(e),e.parent=null,e.step=0,e.move.blockIdx=0,e.move.dirIdx=0,!r||0===r.length)return null;if("object"!=typeof r[0])return null;for(var t=0;t<r.length;t++){if(!a(e,t,{shape:r[t].shape,row:r[t].position[0],col:r[t].position[1]}))return null}return function(r){var o,e;for(b={key:[]},o=0;o<v;o++)for(b.key[o]=[],e=0;e<x;e++)b.key[o][e]={value:[]},n(r,b.key[o][e])}(Object.keys(e.types).length),e.hash=function(r){var o,e,t=0,n=r.blocks;for(o=1;o<=v;o++)for(e=1;e<=x;e++){var a=r.board[o][e]-1,s=0<=a&&a<n.length?k(r.types,n[a].shape):0;t^=b.key[o-1][e-1].value[s]}return t}(e),e.hashMirror=function(r){var o,e,t=0,n=r.blocks;for(o=1;o<=v;o++)for(e=1;e<=x;e++){var a=r.board[o][e]-1,s=0<=a&&a<n.length?k(r.types,n[a].shape):0;t^=b.key[o-1][x-e].value[s]}return t}(e),o.states.push(e),o}function s(r,o){var e=o.hash;if(r.zhash[e]=!0,p){var t=o.hashMirror;r.zhash[t]=!0}}function l(r,o){for(var e=o;e;){if(0<e.step){var t={step:e.step,blockIdx:e.move.blockIdx,dirIdx:e.move.dirIdx};r.result.moves.push(t)}e=e.parent}}function i(r,o){for(var e=0;e<o.blocks.length;e++)for(var t=0;t<4;t++)c(r,o,e,t)}function c(r,o,e,t){var n=h(r,o,e,t);n&&d(r,n)&&function(r,o,e,t){for(var n=0;n<4;n++)if((n+2)%4!==t){var a=h(r,o,e,n);a&&d(r,a)&&a.step--}}(r,n,e,t)}function h(r,o,e,t){if(function(r,o,e){for(var t=r.blocks[o],n=t.shape,a=y[e],s=1;s<=n[0];s++)for(var l=1;l<=n[1];l++){var i=r.board[t.row+a.y+s][t.col+a.x+l];if(0!==i&&i!==o+1)return!1}return!0}(o,e,t)){var n=f(o,e,t);if(r.zhash[n])return null;var a=0;if(p&&(a=f(o,e,t,!0),r.zhash[a]))return null;var s=function(r){for(var o=[],e=0;e<w;e++)o[e]=r.board[e].slice(0);var t=[];for(e=0;e<r.blocks.length;e++)t[e]={shape:r.blocks[e].shape.slice(0),row:r.blocks[e].row,col:r.blocks[e].col};var n={};for(var a in r.types)r.types.hasOwnProperty(a)&&(n[a]=r.types[a]);return{board:o,blocks:t,types:n,move:{blockIdx:r.move.blockIdx,dirIdx:r.move.dirIdx},step:r.step,hash:r.hash,hashMirror:r.hashMirror,parent:r.parent}}(o),l=s.blocks[e],i=y[t];return function(r,o,e,t){for(var n=1;n<=o[0];n++)for(var a=1;a<=o[1];a++)r.board[e+n][t+a]=0}(s,l.shape,l.row,l.col),u(s,e,l.shape,l.row+i.y,l.col+i.x),l.row=l.row+i.y,l.col=l.col+i.x,s.blocks[e]=l,s.step=o.step+1,s.parent=o,s.move.blockIdx=e,s.move.dirIdx=t,s.hash=n,p&&(s.hashMirror=a),s}return null}function d(r,o){var e=o.hash,t=0;return!r.zhash[e]&&((!p||(t=o.hashMirror,!r.zhash[t]))&&(r.zhash[e]=!0,p&&(r.zhash[t]=!0),r.states.push(o),!0))}this.solve=function(r){if(r&&(r.hasOwnProperty("useMirror")&&"boolean"==typeof r.useMirror&&(p=r.useMirror),r.hasOwnProperty("boardSize")&&"[object Array]"===Object.prototype.toString.call(r.boardSize)&&2===r.boardSize.length&&(v=r.boardSize[0],x=r.boardSize[1],I=x+2,w=v+2),r.hasOwnProperty("escapePoint")&&"[object Array]"===Object.prototype.toString.call(r.escapePoint)&&2===r.escapePoint.length&&(m=r.escapePoint[0],g=r.escapePoint[1]),r.hasOwnProperty("blocks")&&"[object Array]"===Object.prototype.toString.call(r.blocks))){var o=e(r.blocks);if(o&&function(r){for(var o,e=0;e<r.states.length;){var t=r.states[e++];if(s(r,t),void 0,(o=t.blocks[0]).row===m&&o.col===g)return l(r,t),!0;i(r,t)}return!1}(o))return o.result.moves.reverse()}return null},this.mergeSteps=function(r){if(!r||0===r.length)return r;var o=[];o[0]={blockIdx:r[0].blockIdx,dirIdx:r[0].dirIdx,count:1};for(var e=1;e<r.length;e++){var t=o[o.length-1],n=r[e];n.blockIdx===t.blockIdx&&n.dirIdx===t.dirIdx?t.count++:o.push({blockIdx:n.blockIdx,dirIdx:n.dirIdx,count:1})}return o}}"undefined"!=typeof define&&null!==define&&define.amd?define(function(){return r}):"undefined"!=typeof module&&null!==module&&"undefined"!=typeof exports&&module.exports===exports?module.exports=r:"undefined"!=typeof self&&"function"==typeof self.postMessage&&"function"==typeof self.importScripts?self.Klotski=r:"undefined"!=typeof window&&null!==window&&(window.Klotski=r)}();